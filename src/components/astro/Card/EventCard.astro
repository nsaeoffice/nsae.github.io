---
import Badge from "@/components/astro/Badge.astro";
import Button from "@/components/astro/Button/Button.astro";
import FormattedDate from "@/components/FormattedDate.astro";
import { Image } from "astro:assets";
import ArrowNarrowRight from "@tabler/icons/outline/arrow-narrow-right.svg";
import CalendarEvent from "@tabler/icons/outline/calendar-event.svg";
import MapPin from "@tabler/icons/outline/map-pin.svg";
import Video from "@tabler/icons/outline/video.svg";
import ArrowUpRight from "@tabler/icons/outline/arrow-up-right.svg";
import type { CollectionEntry } from "astro:content";

type Props = CollectionEntry<"events">;

const { data } = Astro.props;
const formatEventType = (type: string) => {
  return type
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};
const isOnline =
  data.location?.type === "online" || data.location?.type === "hybrid";
---

<article
  class="split-card grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 p-6 md:p-8 group rounded-2xl"
>
  <div class="flex flex-col gap-4 md:col-span-2 lg:col-span-1">
    <div class="flex items-center justify-between">
      <Badge
        variant="outline"
        class="font-mono text-xs uppercase tracking-widest border-border/50 bg-background/50"
      >
        {formatEventType(data.eventType)}
      </Badge>
      <span class="md:hidden font-mono text-xs text-muted-foreground uppercase">
        <FormattedDate date={data.eventStart} />
      </span>
    </div>

    <div class="flex flex-col gap-2 grow">
      <h3
        class="split-target font-sans text-2xl md:text-3xl font-medium leading-snug pb-1"
      >
        {data.title}
      </h3>
      {
        data.subtitle && (
          <p class="font-sans text-sm text-muted-foreground line-clamp-3">
            {data.subtitle}
          </p>
        )
      }
    </div>

    <div
      class="mt-auto hidden md:flex items-center gap-1 font-mono text-xs uppercase tracking-widest text-foreground hover:text-primary transition-colors pt-4"
    >
      <span>View Details</span>
      <ArrowNarrowRight
        class="w-4 h-4 group-hover:translate-x-1 transition-transform"
      />
    </div>
  </div>

  <div
    class="flex flex-col gap-6 md:col-span-1 lg:border-l border-border/50 lg:pl-6 justify-center"
  >
    <div class="flex gap-3 items-start">
      <div
        class="p-2 bg-secondary/50 rounded-lg shrink-0 border border-border/50"
      >
        <CalendarEvent class="w-5 h-5 text-primary" />
      </div>
      <div>
        <p class="font-sans font-medium text-sm">Date</p>
        <p class="font-mono text-sm text-foreground">
          <FormattedDate date={data.eventStart} />
          {
            data.eventEnd > data.eventStart && (
              <>
                {" "}
                - <FormattedDate date={data.eventEnd} />
              </>
            )
          }
        </p>
      </div>
    </div>

    <div class="flex gap-3 items-start">
      <div
        class="p-2 bg-secondary/50 rounded-lg shrink-0 border border-border/50"
      >
        {
          isOnline ? (
            <Video class="w-5 h-5 text-primary" />
          ) : (
            <MapPin class="w-5 h-5 text-primary" />
          )
        }
      </div>
      <div class="min-w-0">
        <p class="font-sans font-medium text-sm">
          {isOnline ? "Online" : "Location"}
        </p>
        <p class="font-mono text-sm text-foreground truncate">
          {
            data.location?.type === "in_person"
              ? data.location.venueName
              : "Join via Link"
          }
        </p>
        {
          data.location?.city && (
            <p class="font-mono text-xs text-muted-foreground/70 tracking-wide">
              {data.location.city}
            </p>
          )
        }
      </div>
    </div>

    {
      data.registrationLink && (
        <div class="pt-2">
          <Button href={data.registrationLink} class="font-sans font-medium">
            Register Now
            <ArrowUpRight class={"ml-2 size-4"} />
          </Button>
        </div>
      )
    }
  </div>

  {
    data.coverImage && (
      <div class="md:col-span-3 lg:col-span-2 rounded-2xl overflow-hidden min-h-[250px] lg:h-auto relative">
        <Image
          inferSize
          class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-[1.02]"
          src={data.coverImage}
          alt={data.title ?? ""}
        />
      </div>
    )
  }
</article>

<style is:global>
  .split-word {
    position: relative;
    display: inline-block;
    margin-right: 0.25em;
    --underline-scale: 0;
    --transform-origin: right center;
  }
  .split-word::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: currentColor;
    transform: scaleX(var(--underline-scale));
    transform-origin: var(--transform-origin);
  }
</style>

<script>
  import gsap from "gsap";
  import SplitText from "gsap/SplitText";

  if (typeof window !== "undefined") {
    window.addEventListener("load", () => {
      gsap.registerPlugin(SplitText);

      const cards = document.querySelectorAll(".split-card");

      cards.forEach((card) => {
        const target = card.querySelector(".split-target");
        if (!target) return;

        let split = SplitText.create(target, {
          type: "words",
          wordsClass: "split-word",
        });

        const words = split.words;
        let isInitialAnimComplete = false;

        gsap.from(words, {
          y: 20,
          autoAlpha: 0,
          duration: 0.6,
          ease: "power2.out",
          stagger: 0.05,
          onComplete: () => {
            isInitialAnimComplete = true;
          },
        });

        card.addEventListener("mouseenter", () => {
          if (!isInitialAnimComplete) return;

          gsap.set(words, {
            "--transform-origin": "left center",
          });
          gsap.to(words, {
            "--underline-scale": 1,
            duration: 0.4,
            ease: "power3.out",
            stagger: 0.04,
            overwrite: "auto",
          });
        });

        card.addEventListener("mouseleave", () => {
          if (!isInitialAnimComplete) return;

          gsap.set(words, {
            "--transform-origin": "right center",
          });
          gsap.to(words, {
            "--underline-scale": 0,
            duration: 0.3,
            ease: "power3.in",
            stagger: 0.03,
            overwrite: true,
          });
        });
      });
    });
  }
</script>
