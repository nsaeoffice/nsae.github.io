---
import X from "@tabler/icons/outline/x.svg";

interface Props {
  id?: string;
  label?: string;
  message: string;
  href?: string;
  linkText?: string;
  class?: string;
}

const {
  id = "global-announcement",
  label = "Announcement",
  message,
  href,
  linkText = "Read more here.",
  class: className,
} = Astro.props;

const storageKey = `announcement-dismissed-${id}`;
---

<div
  role="alert"
  id={id}
  data-storage-key={storageKey}
  class:list={[
    "announcement-ribbon bg-foreground rounded-md text-background px-4 py-1 flex items-center gap-2 mb-4 transition-opacity duration-300",
    className,
  ]}
>
  <script is:inline define:vars={{ id, storageKey }}>
    if (localStorage.getItem(storageKey) === "true") {
      const ribbon = document.getElementById(id);
      if (ribbon) ribbon.style.display = "none";
    }
  </script>

  <button
    type="button"
    aria-label="Close announcement"
    class="cursor-pointer close-ribbon-btn shrink-0 mr-4 md:mr-8 hover:opacity-70 transition-opacity"
  >
    <X class="w-3 h-3" />
  </button>

  <div class="flex flex-wrap items-baseline gap-1 md:gap-2">
    <span class="font-mono text-xs uppercase tracking-widest opacity-80">
      {label}:
    </span>

    <span class="font-medium">{message}</span>

    {
      href && (
        <a
          href={href}
          class="italic underline decoration-1 underline-offset-2 ml-1 transition-colors"
        >
          {linkText}
        </a>
      )
    }
  </div>
</div>

<script>
  const ribbons = document.querySelectorAll<HTMLElement>(
    ".announcement-ribbon"
  );

  ribbons.forEach((ribbon) => {
    const btn = ribbon.querySelector(".close-ribbon-btn");
    const storageKey = ribbon.dataset.storageKey;

    btn?.addEventListener("click", () => {
      if (storageKey) {
        localStorage.setItem(storageKey, "true");
      }
      ribbon.remove();
    });
  });
</script>
